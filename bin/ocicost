#!/bin/bash
set -e
shopt -s expand_aliases

# OCI 别名配置
oci() {
  docker run --rm -i \
    -e "OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING=True" \
    -v "$HOME/.oci:/oracle/.oci" oci "$@"
}

# 检查环境
for cmd in jq curl column; do
  if ! command -v $cmd >/dev/null 2>&1; then
    echo "Error: $cmd missing. Please install it."
    exit 1
  fi
done

if [[ -z "$T" ]]; then
  echo "Missing tenancy OCID. export T=\"ocid1.tenancy...\""
  exit 1
fi

END=$(date +%Y-%m-%d)
START=$(date -d "-60 days" +%Y-%m-%d)

echo "--- Fetching Costs from $START to $END ---"

# 1. 获取原始数据并按货币分组计算总量
# 直接通过管道流处理，减少磁盘 IO
GROUPED_JSON=$(oci usage-api usage-summary request-summarized-usages \
  --tenant-id "$T" \
  --time-usage-started "$START" \
  --time-usage-ended "$END" \
  --granularity DAILY \
  --query-type COST \
  --output json | jq -c '
    [ .data.items[] 
      | select((."attributed-cost" | tonumber) > 0) 
      | { currency: (."currency" // "USD"), cost: (."attributed-cost" | tonumber) }
    ] | group_by(.currency) | map({
        currency: .[0].currency,
        total: (map(.cost) | add)
    })
  ')

echo -e "\n=================== COST SUMMARY ==================="
echo "$GROUPED_JSON" | jq -r '.[] | "Currency: \(.currency)\tTotal: \(.total)"' | column -t
echo "===================================================="

# 2. 动态多货币转换为 USD
# 获取汇率表（以 USD 为基准）
EXCHANGE_DATA=$(curl -s https://api.exchangerate-api.com/v4/latest/USD)
RATES=$(echo "$EXCHANGE_DATA" | jq -c '.rates')

echo -e "\n=================== USD CONVERSION =================="

# 使用 jq 处理：如果货币本身是 USD，倍率为 1；否则去 RATES 里找对应的倒数 (1/Rate)
TOTAL_USD=$(echo "$GROUPED_JSON" | jq -r --argjson rates "$RATES" '
  .[] | 
  if .currency == "USD" then 
    .total 
  else 
    (.total / ($rates[.currency] // 1)) 
  end 
' | awk '{sum+=$1} END {print sum}')

# 打印详细转换结果（可选）
echo "$GROUPED_JSON" | jq -r --argjson rates "$RATES" '
  .[] | select(.currency != "USD") | 
  "Converting \(.currency): \(.total) -> USD \(.total / ($rates[.currency] // 1) | round)"
'

echo "-----------------------------------------------------"
echo "Grand Total (USD Estimate): $TOTAL_USD"
echo "====================================================="
echo

# 3. 按资源显示明细 (保持原逻辑优化)
echo "--- Top Resource Costs (Monthly Detail) ---"
oci usage-api usage-summary request-summarized-usages \
  --tenant-id "$T" \
  --time-usage-started "$START" \
  --time-usage-ended "$END" \
  --granularity MONTHLY \
  --query-type COST \
  --group-by '["resourceId"]' \
  --output json \
| jq -r '
    .data.items[]
    | select((.["attributed-cost"] // "0" | tonumber) > 0)
    | [ (."resource-id" // "-"), (.["attributed-cost"] // "0") ]
    | @tsv
' | sort -k2 -nr | head -n 20 | column -t
