#!/usr/bin/env bash
source ~/.bashrc
shopt -s expand_aliases

oci() {
  docker run --rm \
    -e "OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING=True" \
    -v "$HOME/.oci:/oracle/.oci" oci "$@"
}

LOG=~/A1loop.log
echo "===== A1 Create Loop Started: $(date) =====" | tee -a "$LOG"

C=$(curl -sf http://169.254.169.254/opc/v1/instance/ | jq -r .compartmentId)
T=$(curl -sf http://169.254.169.254/opc/v1/instance/ | jq -r .tenantId)
AD=$(oci iam availability-domain list -c $C | jq -r '.data[].name')
VCN=$(oci network vcn list -c $C|jq -r '.data[].id')
SI=$(oci network subnet list -c $C | jq -r '.data[].id')


I=$(oci compute image list -c $C --all   | jq -r '.data[] | select(.["operating-system"]=="Canonical Ubuntu") | "\(.id) | \(.["display-name"]) | \(.["operating-system-version"])"' | grep -m 1 "Canonical-Ubuntu-24.04-aarch64" | awk '{print $1}')

H=$(oci iam tenancy get --tenancy-id "$C" | jq -r '.data["home-region-key"]')


while true; do
    echo "$(date) üëâ Attempting to create A1 instance..." | tee -a "$LOG"

    RAND=$(openssl rand -hex 2)
    DISPLAY_NAME="$H-A1-2C12G-$RAND"

    # ÊçïËé∑ËæìÂá∫
    RESULT=$(oci compute instance launch \
        --compartment-id "$C" \
        --availability-domain "$AD" \
        --display-name "$DISPLAY_NAME" \
        --subnet-id "$SI" \
        --shape VM.Standard.A1.Flex \
        --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
        --boot-volume-size-in-gbs 50 \
        --image-id "$I" \
        --assign-public-ip true \
        --ssh-authorized-keys-file .oci/id_rsa.pub \
        --wait-for-state RUNNING 2>&1)

    echo "$RESULT" | tee -a "$LOG"

    # ÂéªÊéâÁ¨¨‰∏ÄË°åÈùû JSONÔºàÂ¶Ç "ServiceError:"Ôºâ
    JSON=$(echo "$RESULT" | sed '1{/^ServiceError:/d}')

    # Âà§Êñ≠ÊàêÂäü
    if echo "$JSON" | jq -e '.data.id' >/dev/null 2>&1; then
        echo "$(date) ‚úÖ SUCCESS: Instance created! Name: $DISPLAY_NAME" | tee -a "$LOG"
        exit 0
    else
        ERR=$(echo "$JSON" | jq -r '.message // .code // "unknown error"' 2>/dev/null)
        echo "$(date) ‚ùå FAILED: $ERR" | tee -a "$LOG"
	SLEEP_TIME=$(shuf -i 240-300 -n 1)
        echo "$(date) ‚è≥ Retrying in $SLEEP_TIME seconds..." | tee -a "$LOG"
        sleep $SLEEP_TIME
    fi
done

